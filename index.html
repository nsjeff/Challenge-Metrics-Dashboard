<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Implementation Challenges Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2a2a2a;
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .title-box {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #1a237e 0%, #000000 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(1, 107, 255, 0.3);
        }
        
        .title-box h1 {
            color: #ffffff;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-weight: 600;
        }
        
        .controls {
            background-color: #383838;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .control-section {
            margin-bottom: 15px;
        }
        
        .control-section h4 {
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #ffffff;
            font-size: 14px;
        }
        
        .upload-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a237e 0%, #000000 100%);
            color: white;
            border: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #666666 0%, #000000 100%) !important;
            color: white !important;
            border: none;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
        }
        
        .chart-card {
            background-color: #383838;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: #ffffff;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .horizontal-bars {
            height: 350px;
            position: relative;
        }
        
        .bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            height: 50px;
        }
        
        .bar-label {
            width: 200px;
            color: #ffffff;
            font-size: 11px;
            text-align: right;
            padding-right: 10px;
            line-height: 1.2;
        }
        
        .bar {
            height: 30px;
            min-width: 2px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 5px;
            color: #ffffff;
            font-size: 10px;
            font-weight: bold;
        }
        
        .axis-labels {
            display: flex;
            margin-top: 10px;
            padding-left: 210px;
        }
        
        .axis-label {
            color: #ffffff;
            font-size: 10px;
        }
        
        .axis-title {
            text-align: center;
            color: #ffffff;
            font-size: 12px;
            margin-top: 5px;
            padding-left: 70px;
        }
        
        .welcome {
            background-color: #383838;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            color: #ffffff;
        }
        
        .welcome h3 {
            margin-bottom: 20px;
            color: #00D9FF;
        }
        
        .welcome p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        #file-upload {
            display: none;
        }

        .status-message {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }

        .error-message {
            background-color: #f44336;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Password Protection Screen -->
    <div id="auth-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a237e 0%, #000000 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; font-family: 'Inter', sans-serif;">
        <div style="background: rgba(56, 56, 56, 0.95); padding: 40px; border-radius: 12px; text-align: center; color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
            <h2 style="margin-bottom: 20px; color: #00D9FF; font-size: 1.8rem;">ðŸ”’ Dashboard Access</h2>
            <p style="margin-bottom: 25px; color: #ffffff; opacity: 0.9;">Enter password to access Implementation Challenges Dashboard</p>
            <input type="password" id="password-input" placeholder="Enter password" style="padding: 12px 16px; margin: 10px; border: none; border-radius: 6px; background: #2a2a2a; color: white; font-size: 16px; width: 250px;" onkeypress="handleKeyPress(event)">
            <br>
            <button onclick="checkPassword()" style="padding: 12px 24px; background: linear-gradient(135deg, #1a237e 0%, #000000 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; margin-top: 10px;">Access Dashboard</button>
            <div id="error-message" style="color: #f44336; margin-top: 15px; display: none;">Incorrect password. Please try again.</div>
        </div>
    </div>

    <div class="container">
        <div class="title-box">
            <h1>Implementation Challenges Dashboard</h1>
        </div>
        
        <div class="controls">
            <div id="status-message" class="status-message"></div>
            <div id="error-message" class="error-message"></div>
            
            <div class="upload-buttons">
                <button class="btn btn-primary" onclick="triggerFileUpload()">
                    Upload Challenge Report
                </button>
                <input type="file" id="file-upload" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                <button class="btn btn-secondary" onclick="resetFilters()">
                    Reset Filters
                </button>
            </div>
            
            <div class="control-section">
                <h4>Months:</h4>
                <div class="checkbox-group" id="month-filters">
                    <!-- Will be populated when data is uploaded -->
                </div>
            </div>
            
            <div class="control-section">
                <h4>Categories:</h4>
                <div class="checkbox-group" id="category-filters">
                    <!-- Will be populated when data is uploaded -->
                </div>
            </div>
        </div>
        
        <div class="welcome" id="welcome-message">
            <h3>Welcome to Your Implementation Challenges Dashboard!</h3>
            <p>Get started by uploading your first challenge report using the button above.</p>
            <p>The dashboard will automatically create visualizations showing:</p>
            <ul style="text-align: left; max-width: 600px; margin: 20px auto;">
                <li>Monthly hours lost by category</li>
                <li>Top 5 challenges by hours lost</li>
                <li>Percentage breakdown of records vs hours</li>
                <li>Install trends and month-over-month changes</li>
                <li>Challenge distribution across categories</li>
                <li>Record counts per category by month</li>
            </ul>
        </div>
        
        <div class="charts-grid" id="charts-container" style="display: none;">
            <!-- Charts will be populated here after data upload -->
        </div>

        <div style="text-align: center; margin-top: 40px; padding: 20px;">
            <button class="btn btn-secondary" onclick="undoLastUpload()" style="font-size: 12px; padding: 8px 16px; margin-right: 15px;">
                Undo Last Upload
            </button>
            <button class="btn btn-secondary" onclick="clearAllData()" style="font-size: 12px; padding: 8px 16px;">
                Clear All Data
            </button>
        </div>
    </div>

    <script>
        // Password protection
        const accessPassword = "dashboard2024";  // Change this to your desired password
        
        function checkPassword() {
            const enteredPassword = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('error-message');
            
            if (enteredPassword === accessPassword) {
                document.getElementById('auth-screen').style.display = 'none';
                errorMsg.style.display = 'none';
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkPassword();
            }
        }
        
        // Focus password input when page loads
        window.onload = function() {
            document.getElementById('password-input').focus();
        };

        // PIN protection
        const masterPIN = "2024";  // Single PIN for all protected actions
        
        // Track last upload for undo functionality
        let lastUploadData = null;
        
        // Global data storage
        let challengesData = [];
        let installsData = {};
        let selectedMonths = [];
        let selectedCategories = [];
        let availableCategories = [];
        
        // Month order for proper sorting
        const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        // Category colors
        const categoryColors = {
            'Client': '#016BFF',
            'Data': '#F3F3F3',
            'Facility': '#00D9FF',
            'Hardware': '#CCCCCC',
            'Integration': '#808080',
            'Internet': '#4D4D4D',
            'Other': '#CCFF33',
            'Software': '#2d35d6',
            'Shipping': '#97dce6'
        };

        // Verify PIN function
        function verifyPIN(action) {
            const enteredPIN = prompt(`Enter PIN to ${action} data:`);
            
            if (enteredPIN === null) {
                return false;
            }
            
            if (enteredPIN !== masterPIN) {
                showStatus(`Incorrect PIN for ${action} operation!`, true);
                return false;
            }
            
            return true;
        }

        // Show status message
        function showStatus(message, isError = false) {
            const statusEl = document.getElementById('status-message');
            const errorEl = document.getElementById('error-message');
            
            if (isError) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                statusEl.style.display = 'none';
            } else {
                statusEl.textContent = message;
                statusEl.style.display = 'block';
                errorEl.style.display = 'none';
            }
            
            setTimeout(() => {
                statusEl.style.display = 'none';
                errorEl.style.display = 'none';
            }, 5000);
        }

        // Trigger file upload
        function triggerFileUpload() {
            console.log('Upload button clicked');
            
            if (!verifyPIN('upload')) {
                return;
            }
            
            const fileInput = document.getElementById('file-upload');
            if (fileInput) {
                fileInput.click();
                console.log('File input triggered');
            } else {
                console.error('File input not found');
                showStatus('Error: File input not found', true);
            }
        }
        
        // Process row data
        function processRow(row, month) {
            const challenge = row['Implementation Challenge'] || '';
            const parts = challenge.split(' - ');
            
            let category = parts[0]?.trim() || 'Other';
            
            if (category.toLowerCase().includes('hardware-') || category.toLowerCase().includes('hardware -')) {
                category = 'Hardware';
            }
            
            const specificChallenge = parts[1]?.trim() || challenge;
            const hoursLost = parseFloat(row['Hours Lost']);
            const validHours = !isNaN(hoursLost) && isFinite(hoursLost) ? hoursLost : 0;
            
            return {
                account: row['Account'] || '',
                hoursLost: validHours,
                category: category,
                challenge: specificChallenge,
                month: month,
                challengeNumber: row['Challenge: Challenge #'] || ''
            };
        }
        
        // Validate and format month name
        function validateAndFormatMonth(input) {
            if (!input || typeof input !== 'string') {
                return null;
            }
            
            const cleanInput = input.trim().toLowerCase();
            
            // Find matching month (case-insensitive)
            const matchedMonth = monthOrder.find(month => 
                month.toLowerCase() === cleanInput || 
                month.toLowerCase().substring(0, 3) === cleanInput.substring(0, 3)
            );
            
            return matchedMonth || null;
        }

        // Handle file upload
        function handleFileUpload(event) {
            console.log('handleFileUpload called');
            showStatus('Processing file...');
            
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                showStatus('No file selected', true);
                return;
            }
            
            console.log('File selected:', file.name, 'Type:', file.type, 'Size:', file.size);
            
            let monthName;
            while (!monthName) {
                const monthInput = prompt("Enter the month for this data (e.g., 'May', 'January', 'Dec'):");
                if (monthInput === null) {
                    // User cancelled
                    showStatus('Upload cancelled.', true);
                    event.target.value = '';
                    return;
                }
                
                const validatedMonth = validateAndFormatMonth(monthInput);
                if (validatedMonth) {
                    monthName = validatedMonth;
                } else {
                    alert(`"${monthInput}" is not a valid month. Please enter a valid month name like "January", "Feb", "March", etc.`);
                }
            }
            
            const installsInput = prompt(`Enter the number of installs for ${monthName}:`);
            let installs = 0;
            if (installsInput && installsInput.trim() !== '') {
                installs = parseInt(installsInput.trim());
                if (isNaN(installs) || !isFinite(installs) || installs < 0) {
                    showStatus('Invalid number of installs. Please enter a valid number.', true);
                    event.target.value = '';
                    return;
                }
            }
            
            try {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        console.log('File read successfully, processing...');
                        showStatus('Reading file data...');
                        
                        const data = new Uint8Array(e.target.result);
                        
                        if (typeof XLSX === 'undefined') {
                            throw new Error('XLSX library not loaded');
                        }
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('Workbook created, sheet names:', workbook.SheetNames);
                        
                        if (workbook.SheetNames.length === 0) {
                            throw new Error('No sheets found in the Excel file');
                        }
                        
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet);
                        
                        console.log('Data extracted:', jsonData.length, 'rows');
                        console.log('Sample data:', jsonData.slice(0, 2));
                        
                        if (jsonData.length === 0) {
                            throw new Error('No data found in the Excel file');
                        }
                        
                        installsData[monthName] = installs;
                        console.log('Installs data stored:', monthName, installs);
                        
                        showStatus('Processing challenge data...');
                        const newData = jsonData
                            .filter(row => row && typeof row === 'object')
                            .map(row => processRow(row, monthName))
                            .filter(item => item && item.category && !isNaN(item.hoursLost));
                        
                        console.log('Processed data:', newData.length, 'valid records');
                        console.log('Sample processed:', newData.slice(0, 2));
                        
                        if (newData.length === 0) {
                            throw new Error('No valid challenge data found! Please check your Excel file format.');
                        }
                        
                        challengesData = [...challengesData, ...newData];
                        console.log('Total challenge data now:', challengesData.length);
                        
                        // Store last upload info for undo functionality
                        lastUploadData = {
                            month: monthName,
                            recordCount: newData.length,
                            installs: installs,
                            data: newData
                        };
                        
                        updateAvailableCategories();
                        
                        if (!selectedMonths.includes(monthName)) {
                            selectedMonths.push(monthName);
                            addMonthToFilters(monthName);
                        }
                        
                        document.getElementById('welcome-message').style.display = 'none';
                        document.getElementById('charts-container').style.display = 'grid';
                        
                        updateCharts();
                        
                        const installMessage = installs > 0 ? ` and ${installs} installs` : '';
                        showStatus(`Successfully added ${newData.length} challenge records${installMessage} for ${monthName}!`);
                        
                        event.target.value = '';
                        
                    } catch (error) {
                        console.error('Error processing file:', error);
                        showStatus('Error processing file: ' + error.message, true);
                        event.target.value = '';
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Error reading file:', error);
                    showStatus('Error reading file!', true);
                    event.target.value = '';
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error with file upload:', error);
                showStatus('Error uploading file: ' + error.message, true);
                event.target.value = '';
            }
        }
        
        function addMonthToFilters(monthName) {
            const monthFilters = document.getElementById('month-filters');
            const existingMonths = Array.from(monthFilters.querySelectorAll('input')).map(input => input.value);
            
            if (existingMonths.includes(monthName)) return;
            
            const allMonths = [...existingMonths, monthName];
            allMonths.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            
            monthFilters.innerHTML = '';
            allMonths.forEach(month => {
                const isSelected = selectedMonths.includes(month);
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `
                    <input type="checkbox" value="${month}" ${isSelected ? 'checked' : ''} onchange="updateFilters()">
                    ${month}
                `;
                monthFilters.appendChild(label);
            });
        }
        
        function updateAvailableCategories() {
            availableCategories = [...new Set(challengesData.map(d => d.category))].filter(Boolean);
            selectedCategories = [...availableCategories];
            updateCategoryFilters();
        }
        
        function updateCategoryFilters() {
            const container = document.getElementById('category-filters');
            container.innerHTML = '';
            
            availableCategories.forEach(category => {
                const isSelected = selectedCategories.includes(category);
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `
                    <input type="checkbox" value="${category}" ${isSelected ? 'checked' : ''} onchange="updateFilters()">
                    <span style="color: ${categoryColors[category] || '#ffffff'}; font-weight: bold;">
                        ${category}
                    </span>
                `;
                container.appendChild(label);
            });
        }
        
        function resetFilters() {
            if (challengesData.length === 0) {
                showStatus('Please upload data first!', true);
                return;
            }
            
            selectedMonths = [...Object.keys(installsData)];
            selectedCategories = [...availableCategories];
            
            const monthCheckboxes = document.querySelectorAll('#month-filters input[type="checkbox"]');
            monthCheckboxes.forEach(checkbox => {
                checkbox.checked = selectedMonths.includes(checkbox.value);
            });
            
            const categoryCheckboxes = document.querySelectorAll('#category-filters input[type="checkbox"]');
            categoryCheckboxes.forEach(checkbox => {
                checkbox.checked = selectedCategories.includes(checkbox.value);
            });
            
            updateCharts();
            showStatus('Filters reset successfully!');
        }
        
        function updateFilters() {
            const monthCheckboxes = document.querySelectorAll('#month-filters input[type="checkbox"]');
            selectedMonths = Array.from(monthCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            const categoryCheckboxes = document.querySelectorAll('#category-filters input[type="checkbox"]');
            selectedCategories = Array.from(categoryCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            updateCharts();
        }
        
        function getFilteredData() {
            return challengesData.filter(item => 
                selectedMonths.includes(item.month) && 
                selectedCategories.includes(item.category)
            );
        }
        
        function createMonthlyChart(filteredData) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const monthlyData = {};
            filteredData.forEach(item => {
                if (!monthlyData[item.month]) {
                    monthlyData[item.month] = {};
                }
                if (!monthlyData[item.month][item.category]) {
                    monthlyData[item.month][item.category] = 0;
                }
                monthlyData[item.month][item.category] += item.hoursLost;
            });
            
            const months = Object.keys(monthlyData).sort((a, b) => {
                return monthOrder.indexOf(a) - monthOrder.indexOf(b);
            });
            
            const datasets = availableCategories.map(category => ({
                label: category,
                data: months.map(month => monthlyData[month][category] || 0),
                backgroundColor: categoryColors[category] || '#CCCCCC',
                borderColor: categoryColors[category] || '#CCCCCC',
                borderWidth: 1
            }));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#555' }
                        },
                        y: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#555' }
                        }
                    }
                }
            });
            
            return canvas;
        }
        
        function createTopChallengesChart(filteredData) {
            const challengeMap = {};
            
            filteredData.forEach(item => {
                const key = `${item.category} - ${item.challenge}`;
                if (!challengeMap[key]) {
                    challengeMap[key] = { hours: 0, category: item.category };
                }
                challengeMap[key].hours += item.hoursLost;
            });
            
            const topChallenges = Object.entries(challengeMap)
                .map(([challenge, data]) => ({ challenge, hours: data.hours, category: data.category }))
                .sort((a, b) => b.hours - a.hours)
                .slice(0, 5);
            
            const container = document.createElement('div');
            container.className = 'horizontal-bars';
            
            if (topChallenges.length === 0) {
                container.innerHTML = '<div style="color: #ffffff; text-align: center; padding: 50px;">No challenge data available</div>';
                return container;
            }
            
            const maxHours = Math.max(...topChallenges.map(c => c.hours));
            
            topChallenges.forEach(item => {
                const barWidth = maxHours > 0 ? (item.hours / maxHours) * 70 : 0;
                const barColor = categoryColors[item.category] || '#CCCCCC';
                
                const barItem = document.createElement('div');
                barItem.className = 'bar-item';
                barItem.innerHTML = `
                    <div class="bar-label">${item.challenge}</div>
                    <div class="bar" style="background-color: ${barColor}; width: ${barWidth}%; color: #000000;">
                        ${item.hours.toFixed(2)}h
                    </div>
                `;
                container.appendChild(barItem);
            });
            
            if (maxHours > 0) {
                const axisLabels = document.createElement('div');
                axisLabels.className = 'axis-labels';
                axisLabels.innerHTML = `
                    <div class="axis-label" style="width: 0%;">0</div>
                    <div class="axis-label" style="width: 35%; text-align: center;">${(maxHours / 2).toFixed(1)}</div>
                    <div class="axis-label" style="width: 35%; text-align: right;">${maxHours.toFixed(1)}</div>
                `;
                container.appendChild(axisLabels);
                
                const axisTitle = document.createElement('div');
                axisTitle.className = 'axis-title';
                axisTitle.textContent = 'Hours Lost';
                container.appendChild(axisTitle);
            }
            
            return container;
        }
        
        function createRecordsVsHoursChart(filteredData) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const categoryStats = {};
            const totalRecords = filteredData.length || 1;
            const totalHours = filteredData.reduce((sum, item) => sum + item.hoursLost, 0) || 1;
            
            filteredData.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = { records: 0, hours: 0 };
                }
                categoryStats[item.category].records += 1;
                categoryStats[item.category].hours += item.hoursLost;
            });
            
            const categories = Object.keys(categoryStats);
            const recordsData = categories.map(cat => (categoryStats[cat].records / totalRecords) * 100);
            const hoursData = categories.map(cat => (categoryStats[cat].hours / totalHours) * 100);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: '% of All Records',
                        data: recordsData,
                        backgroundColor: '#016BFF',
                        borderColor: '#016BFF',
                        borderWidth: 1
                    }, {
                        label: '% of All Hours',
                        data: hoursData,
                        backgroundColor: '#00D9FF',
                        borderColor: '#00D9FF',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#ffffff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: '#555' }
                        },
                        y: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#555' }
                        }
                    }
                }
            });
            
            return canvas;
        }
        
        function createInstallsChart() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const availableMonths = Object.keys(installsData).sort((a, b) => {
                return monthOrder.indexOf(a) - monthOrder.indexOf(b);
            });
            
            if (availableMonths.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.innerHTML = '<div style="color: #ffffff; text-align: center; padding: 50px;">No install data available</div>';
                return emptyDiv;
            }
            
            const chartData = availableMonths.map((month, index) => {
                const currentInstalls = installsData[month] || 0;
                const prevMonth = index > 0 ? availableMonths[index - 1] : null;
                const prevInstalls = prevMonth ? (installsData[prevMonth] || 0) : 0;
                
                // Calculate month-over-month change in installs
                let installsMomChange = 0;
                if (index > 0 && prevInstalls > 0) {
                    installsMomChange = ((currentInstalls - prevInstalls) / prevInstalls) * 100;
                }
                
                // Calculate challenge records for current and previous month
                const currentRecords = challengesData.filter(item => item.month === month).length;
                const prevRecords = prevMonth ? challengesData.filter(item => item.month === prevMonth).length : 0;
                
                // Calculate month-over-month change in challenge records
                let recordsMomChange = 0;
                if (index > 0 && prevRecords > 0) {
                    recordsMomChange = ((currentRecords - prevRecords) / prevRecords) * 100;
                }
                
                console.log(`${month}: Records=${currentRecords}, PrevRecords=${prevRecords}, MoM=${recordsMomChange.toFixed(1)}%`);
                
                return {
                    month: month,
                    installs: currentInstalls,
                    installsMomChange: installsMomChange,
                    recordsMomChange: recordsMomChange
                };
            });
            
            if (window.installsChart && typeof window.installsChart.destroy === 'function') {
                window.installsChart.destroy();
            }
            
            window.installsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.month),
                    datasets: [{
                        label: 'Installs',
                        data: chartData.map(d => d.installs),
                        borderColor: '#016BFF',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#016BFF',
                        pointBorderColor: '#016BFF',
                        yAxisID: 'y',
                        tension: 0
                    }, {
                        label: 'Installs MoM Change %',
                        data: chartData.map(d => d.installsMomChange),
                        borderColor: '#00D9FF',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [5, 3],
                        pointRadius: 4,
                        pointBackgroundColor: '#00D9FF',
                        pointBorderColor: '#00D9FF',
                        yAxisID: 'y1',
                        tension: 0
                    }, {
                        label: 'Records MoM Change %',
                        data: chartData.map(d => d.recordsMomChange),
                        borderColor: '#FFFFFF',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [8, 2],
                        pointRadius: 4,
                        pointBackgroundColor: '#FFFFFF',
                        pointBorderColor: '#FFFFFF',
                        yAxisID: 'y1',
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: '#ffffff',
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            ticks: { 
                                color: '#016BFF',
                                stepSize: 25
                            },
                            grid: { color: '#444' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: -100,
                            max: 100,
                            ticks: { 
                                color: '#00D9FF',
                                stepSize: 25,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
            
            return canvas;
        }
        
        function createDistributionChart(filteredData) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const categoryCount = {};
            filteredData.forEach(item => {
                categoryCount[item.category] = (categoryCount[item.category] || 0) + 1;
            });
            
            const categories = Object.keys(categoryCount);
            const counts = Object.values(categoryCount);
            const colors = categories.map(cat => categoryColors[cat] || '#CCCCCC');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderColor: '#2a2a2a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
            
            return canvas;
        }
        
        function createRecordsPerCategoryChart(filteredData) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const monthlyRecordData = {};
            
            filteredData.forEach(item => {
                if (!monthlyRecordData[item.month]) {
                    monthlyRecordData[item.month] = {};
                }
                if (!monthlyRecordData[item.month][item.category]) {
                    monthlyRecordData[item.month][item.category] = 0;
                }
                monthlyRecordData[item.month][item.category] += 1;
            });
            
            const months = Object.keys(monthlyRecordData).sort((a, b) => {
                return monthOrder.indexOf(a) - monthOrder.indexOf(b);
            });
            
            const datasets = selectedCategories.map(category => ({
                label: category,
                data: months.map(month => monthlyRecordData[month][category] || 0),
                backgroundColor: categoryColors[category] || '#CCCCCC',
                borderColor: categoryColors[category] || '#CCCCCC',
                borderWidth: 1
            }));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: '#ffffff' },
                            grid: { color: '#555' }
                        },
                        y: {
                            stacked: true,
                            ticks: { color: '#ffffff' },
                            grid: { color: '#555' }
                        }
                    }
                }
            });
            
            return canvas;
        }
        
        function updateCharts() {
            const filteredData = getFilteredData();
            const container = document.getElementById('charts-container');
            
            if (!container || filteredData.length === 0) {
                console.log('No data to display charts');
                return;
            }
            
            container.innerHTML = `
                <div class="chart-card">
                    <h3>Monthly Hours Lost by Category</h3>
                    <div class="chart-container" id="monthly-chart"></div>
                </div>
                
                <div class="chart-card">
                    <h3>Top 5 Challenges by Hours Lost</h3>
                    <div class="horizontal-bars" id="top-challenges-chart"></div>
                </div>
                
                <div class="chart-card">
                    <h3>Records vs Hours Distribution</h3>
                    <div class="chart-container" id="records-hours-chart"></div>
                </div>
                
                <div class="chart-card">
                    <h3>Install Trends & MoM Changes</h3>
                    <div class="chart-container" id="installs-container"></div>
                </div>
                
                <div class="chart-card">
                    <h3>Challenge Distribution by Category</h3>
                    <div class="chart-container" id="distribution-chart"></div>
                </div>
                
                <div class="chart-card">
                    <h3>Record Counts per Category by Month</h3>
                    <div class="chart-container" id="records-category-chart"></div>
                </div>
            `;
            
            try {
                document.getElementById('monthly-chart').appendChild(createMonthlyChart(filteredData));
                document.getElementById('top-challenges-chart').appendChild(createTopChallengesChart(filteredData));
                document.getElementById('records-hours-chart').appendChild(createRecordsVsHoursChart(filteredData));
                document.getElementById('installs-container').appendChild(createInstallsChart());
                document.getElementById('distribution-chart').appendChild(createDistributionChart(filteredData));
                document.getElementById('records-category-chart').appendChild(createRecordsPerCategoryChart(filteredData));
            } catch (error) {
                console.error('Error creating charts:', error);
                showStatus('Error creating charts: ' + error.message, true);
            }
        }

        function clearAllData() {
            if (!verifyPIN('clear')) {
                return;
            }
            
            const confirmClear = confirm('Are you sure you want to clear all data? This will remove all uploaded challenge data and reset the dashboard.');
            
            if (confirmClear) {
                challengesData = [];
                installsData = {};
                selectedMonths = [];
                selectedCategories = [];
                availableCategories = [];
                lastUploadData = null;  // Clear undo data too
                
                document.getElementById('month-filters').innerHTML = '';
                document.getElementById('category-filters').innerHTML = '';
                document.getElementById('charts-container').style.display = 'none';
                document.getElementById('welcome-message').style.display = 'block';
                
                if (window.installsChart && typeof window.installsChart.destroy === 'function') {
                    window.installsChart.destroy();
                }
                
                document.getElementById('file-upload').value = '';
                
                showStatus('All data has been cleared successfully!');
                console.log('Dashboard reset to initial state');
            }
        }

        function undoLastUpload() {
            if (!verifyPIN('undo')) {
                return;
            }
            
            if (!lastUploadData) {
                showStatus('No recent upload to undo!', true);
                return;
            }
            
            const confirmUndo = confirm(`Undo the last upload of ${lastUploadData.recordCount} records for ${lastUploadData.month}?`);
            
            if (confirmUndo) {
                // Remove the last uploaded data
                challengesData = challengesData.filter(item => 
                    !(item.month === lastUploadData.month && 
                      lastUploadData.data.some(lastItem => 
                        lastItem.challengeNumber === item.challengeNumber
                      ))
                );
                
                // Remove install data for that month
                delete installsData[lastUploadData.month];
                
                // Update selected months
                selectedMonths = selectedMonths.filter(month => month !== lastUploadData.month);
                
                // Update categories and filters
                updateAvailableCategories();
                
                // Remove month from filters
                const monthFilters = document.getElementById('month-filters');
                const existingMonths = Object.keys(installsData);
                monthFilters.innerHTML = '';
                
                if (existingMonths.length > 0) {
                    existingMonths.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                    existingMonths.forEach(month => {
                        const isSelected = selectedMonths.includes(month);
                        const label = document.createElement('label');
                        label.className = 'checkbox-item';
                        label.innerHTML = `
                            <input type="checkbox" value="${month}" ${isSelected ? 'checked' : ''} onchange="updateFilters()">
                            ${month}
                        `;
                        monthFilters.appendChild(label);
                    });
                }
                
                // Update UI
                if (challengesData.length === 0) {
                    document.getElementById('charts-container').style.display = 'none';
                    document.getElementById('welcome-message').style.display = 'block';
                } else {
                    updateCharts();
                }
                
                showStatus(`Successfully undid upload of ${lastUploadData.recordCount} records for ${lastUploadData.month}!`);
                lastUploadData = null;  // Clear undo data after use
                console.log('Last upload undone');
            }
        }

        // Initialize the dashboard
        console.log('Dashboard initialized');
        
        if (typeof Chart === 'undefined') {
            console.error('Chart.js not loaded');
            showStatus('Chart.js library failed to load', true);
        }
        
        if (typeof XLSX === 'undefined') {
            console.error('XLSX library not loaded');
            showStatus('XLSX library failed to load', true);
        }
    </script>
</body>
</html>
